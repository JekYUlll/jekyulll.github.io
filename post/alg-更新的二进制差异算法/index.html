<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1"><title>更新的二进制差异算法 - HOREB EVAN JEKYULLL BLOG</title>
<meta name=renderer content="webkit"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv=Cache-Control content="no-transform"><meta http-equiv=Cache-Control content="no-siteapp"><meta name=theme-color content="#f8f5ec"><meta name=msapplication-navbutton-color content="#f8f5ec"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="#f8f5ec"><meta name=author content="JekYUlll"><meta name=description content="替换一个二进制文件有以下两个思路：
使用完整的一个新文件直接覆盖旧的文件。 只替换新旧文件之间的差异。通过算法去计算新旧文件之间的差异，然后将差异部分移动到目标机器上。 其中方法一制作的更新就叫做全量更新（Full Update）。而方法二就是二进制差分方式，即增量更新（Delta Update）。
"><meta name=keywords content="JekYUlll,theme,even"><meta name=generator content="Hugo 0.140.0 with theme even"><link rel=canonical href=https://jekyulll.github.io/post/alg-%E6%9B%B4%E6%96%B0%E7%9A%84%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%B7%AE%E5%BC%82%E7%AE%97%E6%B3%95/><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/manifest.json><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link href=/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css rel=stylesheet><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin=anonymous><meta property="og:url" content="https://jekyulll.github.io/post/alg-%E6%9B%B4%E6%96%B0%E7%9A%84%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%B7%AE%E5%BC%82%E7%AE%97%E6%B3%95/"><meta property="og:site_name" content="HOREB EVAN JEKYULLL BLOG"><meta property="og:title" content="更新的二进制差异算法"><meta property="og:description" content="替换一个二进制文件有以下两个思路：
使用完整的一个新文件直接覆盖旧的文件。 只替换新旧文件之间的差异。通过算法去计算新旧文件之间的差异，然后将差异部分移动到目标机器上。 其中方法一制作的更新就叫做全量更新（Full Update）。而方法二就是二进制差分方式，即增量更新（Delta Update）。"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="post"><meta property="article:published_time" content="2025-03-26T04:05:47+08:00"><meta property="article:modified_time" content="2025-03-26T04:05:47+08:00"><meta property="article:tag" content="Algorithm"><meta itemprop=name content="更新的二进制差异算法"><meta itemprop=description content="替换一个二进制文件有以下两个思路：
使用完整的一个新文件直接覆盖旧的文件。 只替换新旧文件之间的差异。通过算法去计算新旧文件之间的差异，然后将差异部分移动到目标机器上。 其中方法一制作的更新就叫做全量更新（Full Update）。而方法二就是二进制差分方式，即增量更新（Delta Update）。"><meta itemprop=datePublished content="2025-03-26T04:05:47+08:00"><meta itemprop=dateModified content="2025-03-26T04:05:47+08:00"><meta itemprop=wordCount content="1932"><meta itemprop=keywords content="Algorithm"><meta name=twitter:card content="summary"><meta name=twitter:title content="更新的二进制差异算法"><meta name=twitter:description content="替换一个二进制文件有以下两个思路：
使用完整的一个新文件直接覆盖旧的文件。 只替换新旧文件之间的差异。通过算法去计算新旧文件之间的差异，然后将差异部分移动到目标机器上。 其中方法一制作的更新就叫做全量更新（Full Update）。而方法二就是二进制差分方式，即增量更新（Delta Update）。"><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script><script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]--></head><body><div id=mobile-navbar class=mobile-navbar><div class=mobile-header-logo><a href=/ class=logo>Horeb</a></div><div class=mobile-navbar-icon><span></span>
<span></span>
<span></span></div></div><nav id=mobile-menu class="mobile-menu slideout-menu"><ul class=mobile-menu-list><a href=/><li class=mobile-menu-item>Home</li></a><a href=/post/><li class=mobile-menu-item>Archives</li></a><a href=/tags/><li class=mobile-menu-item>Tags</li></a><a href=/categories/><li class=mobile-menu-item>Categories</li></a></ul></nav><div class=container id=mobile-panel><header id=header class=header><div class=logo-wrapper><a href=/ class=logo>Horeb</a></div><nav class=site-navbar><ul id=menu class=menu><li class=menu-item><a class=menu-item-link href=/>Home</a></li><li class=menu-item><a class=menu-item-link href=/post/>Archives</a></li><li class=menu-item><a class=menu-item-link href=/tags/>Tags</a></li><li class=menu-item><a class=menu-item-link href=/categories/>Categories</a></li></ul></nav></header><main id=main class=main><div class=content-wrapper><div id=content class=content><article class=post><header class=post-header><h1 class=post-title>更新的二进制差异算法</h1><div class=post-meta><span class=post-time>2025-03-26</span><div class=post-category><a href=/categories/algorithm/>algorithm</a></div><span class=more-meta>1932 words </span><span class=more-meta>4 mins read</span></div></header><div class=post-toc id=post-toc><h2 class=post-toc-title>Contents</h2><div class="post-toc-content always-active"><nav id=TableOfContents><ul><li><ul><li><a href=#增量更新>增量更新</a></li><li><a href=#正向逆向差分技术>正向/逆向差分技术</a><ul><li><a href=#source--reference>Source && Reference</a></li></ul></li></ul></li></ul></nav></div></div><div class=post-content><p>替换一个二进制文件有以下两个思路：</p><p>使用完整的一个新文件直接覆盖旧的文件。
只替换新旧文件之间的差异。通过算法去计算新旧文件之间的差异，然后将差异部分移动到目标机器上。
其中方法一制作的更新就叫做全量更新（Full Update）。而方法二就是二进制差分方式，即增量更新（Delta Update）。</p><hr><h2 id=增量更新>增量更新</h2><p>增量更新有两个方式：<strong>文件差量更新</strong>、<strong>二进制差量更新</strong>。<br>大部分的大软件，如 QQ 等，都会在自动更新的时候都会使用文件差量更新和二进制差量更新一起使用的策略。</p><p>二进制差分更新对于就文件的状态有严格的要求，这是因为不同版本之间的二进制差异不同。<br>举个例子：某个新的文件A的版本是3，需要更新到用户的机器上。但是部分用户机器上安装的文件A版本是1，部分用户的文件A是版本2。这种情况下，就需要分别计算版本3和版本1的差异，以及版本3和版本2的差异。然后根据不同用户的情况分别发送不同的二进制差异文件。<br>想要进行增量更新，需要构建模块支持才能实现。确定性构建就是在代码没有变更的时候，构建输出的 DLL 或 Exe 一定是不变的。对应的，还应加入确定性混淆的支持，有一些代码接入了混淆过程，要求在代码没有变更的时候，最后混淆输出的文件也没有变更。</p><p>增量更新不能热更新，需要重启才能生效。</p><p>用到的算法主要有<a href=https://www.daemonology.net/bsdiff/>bsdiff</a>，<a href=https://github.com/OctopusDeploy/Octodiff>octodiff</a>，xdelta。</p><p>bsdiff 算法的时间复杂度和空间复杂度都很高。但优点是更新文件大小比较小。</p><blockquote><p>处理大文件选择Octodiff，处理小文件选择bsdiff.</p></blockquote><hr><h2 id=正向逆向差分技术>正向/逆向差分技术</h2><p>在此之前，为了解决Windows累积更新体积过大的问题，微软使用的是Express Update技术。Express技术确实减小了累积更新的体积，但是却极大的增加了Window更新服务器的计算压力与存储压力。Express更新文件在更新服务器上通常会有大于10GB的体积。Express Update正是使用的增量更新方式，并且把所有文件的所有版本差异都存储到了更新服务器上（海量的文件）。</p><p>Windows 10 1809版本之后引入了基于二进制的正向/逆向差分技术。</p><p>二进制差分是需要严格比对文件的版本信息的。如果被替换文件的版本不确定，那么就无法应用二进制差分。如果本替换文件的版本非常多，那么就需要针对每一个版本分别计算二进制差分，这样一来，不同版本的二进制差分的总和体积也必然不会小，因此就抵消掉差分带来的体积优势。</p><p>正向/逆向差分技术的核心思路是：将被替换文件的版本固定，这样就能唯一确定一个二进制差分了。那么，将被替换的文件版本固定成什么版本呢？<br>Windows更新用的方法是，将所有需要被更新的文件版本回到Windows 10 基线版本 。然后，从基线版本安装二进制差分，完成文件的更新。<br>这里，从当前的文件版本回退到基线版本的过程被称为<strong>逆向</strong>，从基线版本更新到最新的版本的过程称为<strong>正向</strong>，也被称为<strong>注水</strong>（hydration）。制作差分二进制叫做<strong>脱水</strong>（dehydration）。<br>这两次文件更新的行为都使用差分二进制来完成，因此这就是正向/逆向二进制差分技术。</p><p>核心逻辑在于通过固定基线版本（RTM）作为唯一中间状态，规避多版本组合带来的差分数爆炸问题。<br>这样只需要存储一个当前版本到基线版本的二进制差分，然后统一从基线版本升级到新版本。<br>（<em>eg</em>. 例如有0、1、2、3、4版本。如果用老办法，需要存储0->1，0->2，0->3，0->4，1->2，1->3，1->4，2->3，2->4，3->4的差分包，多了之后数量爆炸，因为<u>增加新版本的时候需要存储之前所有版本到新版本的差分包</u>。<br>如果采用正向/逆向差分，要存储1->0，2->0，3->0，4->0，然后存储0->1，0->2，0->3，0->4。增加新版本的时候，只需要增加5->0和0->5，从n的累加优化到了n的线性关系的差分包数量。<br>）</p><p>基于正向/逆向二进制差分的Windows累积更新内部包含以下内容：</p><ul><li>从基线版本到最新版本N的正向二进制差分文件</li><li>回退到基线版本所需的逆向二进制差分文件</li><li>更新文件清单（Manifest）</li><li>更新文件Metadata</li></ul><p>如果是离线更新MSU，还会多一些版本以及操作系统适应性判断的内容。</p><hr><h3 id=source--reference>Source && Reference</h3><p><a href=https://zhuanlan.zhihu.com/p/13382743061>二进制差异文件算法</a>。</p><p><a href=https://github.com/Squirrel/Squirrel.Windows>Squirrel.Windows: An installation and update framework for Windows desktop apps</a>。</p><p><a href=https://zhuyie.github.io/posts/bsdiff-annotated/>bsdiff源码解析</a>。</p><p>这段时间看到的最牛逼的文章：<a href=https://jishuzhan.net/article/1874273746852777985#google_vignette>Windows 客户端软件自动更新服务的开发有哪些需求？</a>。</p><p>微软官方对正向/逆向二进制差分Updates的介绍：<a href=https://learn.microsoft.com/en-us/windows/deployment/update/forward-reverse-differentials>Windows Updates using forward and reverse differentials</a>。</p><p><a href="https://www.toutiao.com/article/7156768607085658662/?wid=1742955409104">基于正向/逆向二进制差分的Windows累积更新</a>。</p><p><a href=https://www.toutiao.com/article/7389464626552898082>Windows Update 技术详解系列之快速分发技术Express Update</a>。</p></div><div class=post-copyright><p class=copyright-item><span class=item-title>Author</span>
<span class=item-content>JekYUlll</span></p><p class=copyright-item><span class=item-title>LastMod</span>
<span class=item-content>2025-03-26</span></p><p class=copyright-item><span class=item-title>Markdown</span>
<span class=item-content><a class=link-to-markdown href=https://jekyulll.github.io/post/alg-%E6%9B%B4%E6%96%B0%E7%9A%84%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%B7%AE%E5%BC%82%E7%AE%97%E6%B3%95/index.md target=_blank>The Markdown version »</a></span></p></div><footer class=post-footer><div class=post-tags><a href=/tags/algorithm/>algorithm</a></div><nav class=post-nav><a class=next href=/post/web-nginx-%E7%9A%84%E5%A4%9A%E8%BF%9B%E7%A8%8B%E6%A8%A1%E5%9E%8B/><span class="next-text nav-default">Nginx 的多进程模型</span>
<span class="next-text nav-mobile">Next</span>
<i class="iconfont icon-right"></i></a></nav></footer></article></div></div></main><footer id=footer class=footer><div class=social-links><a href=mailto:jekyulll@gmail.com class="iconfont icon-email" title=email></a><a href=https://github.com/JekYUlll class="iconfont icon-github" title=github></a><a href=https://www.zhihu.com/people/yu-bei-28-33 class="iconfont icon-zhihu" title=zhihu></a><a href=https://space.bilibili.com/11060371 class="iconfont icon-bilibili" title=bilibili></a></div><div class=copyright><span class=power-by>Powered by <a class=hexo-link href=https://gohugo.io>Hugo</a>
</span><span class=division>|</span>
<span class=theme-info>Theme -
<a class=theme-link href=https://github.com/olOwOlo/hugo-theme-even>Even</a>
</span><span class=copyright-year>&copy;
2024 -
2025<span class=heart><i class="iconfont icon-heart"></i></span><span></span></span></div></footer><div class=back-to-top id=back-to-top><i class="iconfont icon-up"></i></div></div><script src="/lib/highlight/highlight.pack.js?v=20171001"></script><script src=https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin=anonymous></script><script type=text/javascript src=/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-Q6473FXND4"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-Q6473FXND4")}</script></body></html>